<!DOCTYPE html>
<html lang="zh-CN">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="Kanily">
  <meta name="keywords" content="Front-End Js Css">
  <title>react/fiber - Kanily&#39;s Blog</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />
<link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/github-gist.min.css" />


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_fmb4a04yx8h.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">




<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


<meta name="generator" content="Hexo 4.2.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Kanily's Blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/">
              <i class="iconfont icon-home-fill"></i>
              首页</a>
          </li>
        
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/archives/">
              <i class="iconfont icon-archive-fill"></i>
              归档</a>
          </li>
        
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/categories/">
              <i class="iconfont icon-category-fill"></i>
              分类</a>
          </li>
        
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/tags/">
              <i class="iconfont icon-tags-fill"></i>
              标签</a>
          </li>
        
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/about/">
              <i class="iconfont icon-user-fill"></i>
              关于</a>
          </li>
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              
                <div class="mt-3 post-meta">
                  <i class="iconfont icon-date-fill" aria-hidden="true"></i>
                  <time datetime="2021-03-18 05:58">
                    2021年3月18日 凌晨
                  </time>
                </div>
              

              <div class="mt-1">
                
                  
                  <span class="post-meta mr-2">
                    <i class="iconfont icon-chart"></i>
                    1.7k 字
                  </span>
                

                
                  
                  <span class="post-meta mr-2">
                      <i class="iconfont icon-clock-fill"></i>
                    
                    
                    27
                     分钟
                  </span>
                

                
              </div>
            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <div class="post-content mx-auto" id="post">
            
            <article class="markdown-body">
              function FiberNode (
    tag: WorkTag,
    pendingProps: mixed,
    key: null | string,
    mode: TypeOfMode
) {
 // 作为静态数据结构的属性
    this.tag = tag; // 对应的组件类型 Function/Class/Host
    this.key = key; // key 属性
    this.elementType = null; //大部分情况相同，某些情况不同，比如FunctionComponent使用React.memo 包裹
    this.type =null; // 对于 FunctionComponent，指函数本身，对于ClassComponent，指class，对于HostComponent，指DOM节点tagName
    this.stateNode = null; // Fiber对应的真实Dom节点

    //用于连接其他fiber节点形成Fiber树

    // 指向父节点
    this.return = null;
    // 指向子fiber节点
    this.child = null;
    // 指向右边第一个兄弟Fiber节点
    this.sibling = null;
    this.index = 0;

    this.ref = null;

    // 作为动态的工作单元的属性
    // 保存本次更新造成的状态改变相关信息
    this.pendingProps = pendingProps;
    this.memorizedProps = null;
    this.updateQueue = null;
    this.memorizedState = null;
    this.dependencies = null;

    this.mode = mode;

    this.effectTag = NoEffect;
    this.nextEffect = null;
    // 保存本次更新会造成的DOM操作
    this.firstEffect = null;
    this.lastEffect = null;

    // 调度优先级相关
    this.lanes = NoLanes;
    this.childLanes = NoLanes;

    // 指向该fiber在另一次更新时对应的fiber
    this.alterate = null
}

function beginWork(
    current: Fiber | null,
    workInProgress: Fiber | null,
    renderLanes: Lanes
) : Fiber | null {
    // update时，如果current存在可能会有优化路径， 可能复用current
    if (current !== null) {
        const oldProps = current.memorizedProps;
        const newProps = current.pendingProps;
        if (oldProps !== newProps ||
            hasLegacyContentChanged() ||
            (__DEV__ ? workInProgress.type !== current.type : false)
        ) {
            didReceiveUpdate = true;
        } else if (!includesSomeLanes(renderLanes, updateQueue)) {
            didReceiveUpdate = false;
            switch (workInProgress) {
                // 省略处理
            }
        } else {
            didReceiveUpdate = false;
        }
        return bailoutOnAlreadyFinishedWork(
            current,
            workInProgress,
            renderLanes
        )
    } else {
        didReceiveUpdate = false;
    }
    // mount时：根据不同的tag类型创建不同的Fiber类型
    switch(workInProgress.tag) {
        case IndeterminateComponent:
            // 省略
        case LazyComponent:
            // 省略
        case ClassComponent:
            // 省略
        case FunctionComponent:
            // 省略
        case ClassComponent:
            // 省略
        case HostRoot:
            // 省略
        case HostComponent:
            // 省略
        case HostTest:

    } 
    
}

export function reconcileChildren (
    current: Fiber | null,
    workInProgress: Fiber,
    nextChildren: any,
    renderLanes: Lanes
) {
    if(current === null) {
        // 对于mount的组件
        workInProgress.child = mountChildFibers(
            workInProgress,
            null,
            nextChildren,
            renderLanes
        )
    } else {
        // 对于update的组件
        workInProgress.child = reconcileChildrenFibers(
            workInProgress,
            current.child,
            nextChildren,
            renderLanes
        )
    }
}

function completeWork(
    current: Fiber | null,
    workInProgress: Fiber,
    renderLanes: Lanes
) : Fiber | null {
    const newProps = workInProgress.pendingProps;
    switch (workInProgress.tag) {
        case HostComponent: {
            popHostContext(workInProgress);
            const rootContainerInstance = getRootHostContainber();
            const type = workInProgress.type;
            // 判断该Fiber节点是否存在的对应的DOM节点
            if (current !== null && workInProgress.stateNode !== null) {
                // update 的情况
                updateHostComponent(
                    current,
                    workInProgress,
                    type,
                    newProps,
                    rootContainerInstance
                )
            } else {
                // mount 的情况
                const currentHostContext = getHostContext();
                // 为fiber创建对应的DOM的节点
                const instance = createInstance(
                    type,
                    newProps,
                    rootContainerInstance,
                    currentHostContext,
                    workInProgress
                );
                // 将子孙DOM节点插入刚生成的DOM节点中
                appendAllChildren(instance, workInProgress, false, false);
                // DOM节点赋值给fiber.stateNode
                workInProgress.stateNode = instance;
                //与update逻辑中updateHost类似处理props的过程
                if(
                    finallyInitialChidren(
                        instance,
                        type,
                        newProps,
                        rootContainerInstance,
                        currentHostContext
                    )
                ) {
                    markUpdate(workInProgress);
                }

            }
        }
    }
}

const update: Update<*> = {
    eventTime,
    lane,
    suspenseConfig,
    tag: UpdateState, // 更新的类型，包括UpdateState， ReplaceStae, ForceUpdate, CaptureUpdate
    payload: null, // 更新挂载数据，不同类型组件挂在数据不一样， 对于ClassComponent, payload 为setState的第一个传参
    callback: null

    next: null
}

const queue: UpdateQueue<State> = {
    baseState: fiber.memorizedState, // 本次更新前该Fiber节点的State， Update基于该State计算更新后的state
    firstBaseUpdate: null, // 本次更新前该Fiber节点已经保存的Update。以链表形式存在，链表头为firstBaseUpdate，
    lastBaseUpdate: null, // 链表尾为lastBaseUpdate， 之所以产生该Fiber节点内就存在Update，是由于某些Update优先级较低 所以在上次render阶段由Update计算被跳过
    shared: {
        pending: null // 触发更新时，产生的Update会保存在share.pending 中形成单项环状链表。当由Update计算state时这个环会被剪开并链接在lastBaseUpdate后面
    },
    effects: null
}

export function createFiberRoot (
    containerInfo: any,
    tag: RootTag,
    hydrate: Boolean,
    hydrationCallback: null | SuspenseHydrationCallbacks,
): FiberRoot {
    // 创建fiberRootNode
    const root: Fiber = (new FiberRootNode(containerInfo, tag, hydrate): any);

    // 创建rootFiber
    const uninitailizedFiber = createHostRootFiber(tag);

    // 链接rootFiber和fiberRootNode
    root.current= uninitalizedFiber;
    uninitalizedFiber.stateNode = root;

    return root;
}


function dispatchAndLog(store, action) {
    console.log('dispatching', action);
    store.dispatch(addTdo('Use Redux'));
    console.log('next state', store.getState());
}

const next = store.dispatch
store.dispatch = function dispatchAndLog(action) {
    console.log('dispatching', action);
    let result = next(action);
    console.log('next state', store.getState());
    return result;
}

function patchStoreToAddLogging(store) {
    const next = store.dispatch
    // store.dispatch = function dispatchAndLog(action) {
    //     console.log('dispatching', action);
    //     let result = next(action);
    //     console.log('next state', store.getState());
    //     return result;
    // }
    return function dispatchAndLog() {
        console.log('dispatching', action);
        let result = next(action);
        console.log('next state', store.getState());
        return result;
    }
}

function patchStoreToAddCrashReporting(store) {
    const next = store.dispatch
    store.dispatch = function dispatchAndReportErrors(action) {
        try {
            return next(action)
        } catch (err) {
            console.log('捕获一个error', err);
            Raven.captureException(err, {
                extra: {
                    action,
                    state: store.getState()
                }
            })
            throw err;
        }
    }
}

function applyMiddlewareByMonkeyPatch(store, middlewares) {
    middlewares = middlewares.slice();
    middlewares.reverse();
    let dispatch = store.dispatch
    middlewares.forEach(middleware => {
        store.dispatch = middleware(store)(dispatch)
    })
    return Object.assign({}, store, {dispatch})
}

function logger(store) {
    return function warpDsipatchToAddLogging(next) {
        return function dispatchAndLog(action) {
            console.log('dispatching');
            let result = next(action);
            console.log('next state', store.getState());
            return result;
        }
    }
}
const logger = store => next => action => {
    console.log('dispatching');
    let result = next(action);
    console.log('next state', store.getState());
    return result;
}

/**
 * @param {string} s
 * @return {number}
 */
var romanToInt = function(s) {
    const map = {
        I : 1,
        IV: 4,
        V: 5,
        IX: 9,
        X: 10,
        XL: 40,
        L: 50,
        XC: 90,
        C: 100,
        CD: 400,
        D: 500,
        CM: 900,
        M: 1000
    };
    let ans = 0;
    for(let i = 0;i < s.length;) {
        if(i + 1 < s.length && map[s.substring(i, i+2)]) {
            ans += map[s.substring(i, i+2)];
            i += 2;
        } else {
            ans += map[s.substring(i, i+1)];
            i ++;
        }
    }
    return ans;
};

const path = require('path');
module.exports = {
    entry: './src/index.js',
    output: {
        path: 'd',
        filename: 'main.js'
    }
}

const fs = require('fs');
const path = require('path')
const parser = require('@babel/parser');
const options = require('webpack.config')
const traverse = require('@babel/traverse').defaut
const { transformFromAst } = require('@babel/core')

const Parse = {
    getAst: path => {
        // 读取入口文件
        const content = fs.readFileSync(path, 'utf-8');
        // 将文件内容转换为AST抽象语法树
        return parser.parser(content, {
            sourceType: 'moudle'
        })
    },
    getDependecies: (ast, filename) => {
        const dependencies = {};
        // 遍历所有的import模块，存入dependecies
        traverse(ast, {
            // 类型为ImportDeclaration的AST节点（即为import语句)
            ImportDecalaration({ node }) {
                const dirname = path.dirname(filename);
                // 保存依赖模块路径，之后生成依赖关系图需要用到
                const filepath = './' + path.join(dirname, node.source.value);
                dependencies[node.source.value] = filepath;
            }
        })
        return dependencies;
    },
    getCode: ast => {
        const { code } = transformFromAst(ast, null, {
            presets: ['@babel/preset-env']
        })
        return code;
    }
}

class Compiler {
    constructor(options) {
        const { entry, output } = options;
        // 入口
        this.entry = entry;
        // 出口
        this.output = output;
        // 模块
        this.moudles = [];
    }
    // 构建启动
    run() {
        const info = this.build(this.entry);
        this.modules.push(info)
        this.modules.forEach((dependencies) => {
            // 判断是否有依赖项递归 解析所有的依赖项
            if(dependencies) {
                for(const dependency in dependencies) {
                    this.modules.push(this.build(dependency))
                }
            }
        })
        // 生成依赖关系图
        const dependencyGraph = this.module.reduce((graph, item)= ({
            ...graph,
             // 使用文件路径作为每个模块的唯一标识符,保存对应模块的依赖对象和文件内容
            [item.filename]: {
                dependencies: item.dependencies,
                code: item.code
            }
        }),
        {}
        )
        this.generate(dependencyGraph);
    }

    build(filename) {
        const { getAst, getDependecies, getCode } = Parser
        const ast = getAst(this.entry);
        const dependencies = getDependecies(this.entry);
        const code = getCode(ast);
        return {
            filename,
            dependencies,
            code
        }
    }
    // 重写 require 函数， 输出bundle
    generate() {
        const filepath = path.join(this.output.path, this.output.filename);
        const bundle = `(function(graph){
            function require(moulde) {
                function localRequire(relativePath) {
                    return require(graph[module].dependencies[relativePath])
                }
                var exports = [];
                (function(require, exports, code){
                    eval(code)
                })(localRequire, exports, graph[module].code)
                return exports
            }
            require('${this.entry}')
        })(${JSON.stringify(code)})`
        // 把文件写入文件系统
        fs.writeFileSync(filepath, bundle, 'utf-8')
    }
}

class Event {
    constructor() {
        this.handlers = {}
    }

    on = (eventName, cb) => {
        const eventCallbackStack = this._getHandler(eventName).callbackStack;
        callbackStack.push(cb)
    }
    emit = (eventName, ...args) => {
        if(this.handlers[eventName]) {
            this.handlers[eventName].eventCallbackStack.forEach(() => {
                cb.call(cb, ...args);
            })
        }
        if(this.handlers[eventName].isOnce) {
            this.off(eventName)
        }
    }

    off = (eventName) => {
        if(this.handlers[eventName]) {
            delete this.handlers[eventName];
        }
    }

    once = () => {
        const eventCallbackStack = this._getHandler(eventName, true).callbackStack;
        callbackStack.push(cb)
    }

    _getHandler = (eventName, isOnce) => {
        if(!this.handlers[eventName]) {
            this.handlers[eventName] = {
                isOnce,
                callbackStack: []
            }
        }
        return this.handlers[eventName]
    }
}

const threeSum = function(nums) {
    let result = [];
    const len = nums.length;
    if(nums == null || len < 2) return result;
    // 排序
    for(let i = 0; i < len; i++) {
        // 如果当前数字大于0， 则三数之和一定大于0， 所以结束循环
        if(nums[i] > 0) break;
        if(i > 0 && nums[i] == nums[i-1]) continue; // 去重
        let left = i + 1;
        let right = len - 1;
        while(left < right) {
            const sum = nums[i] + nums[left] + nums[right];
            if (sum == 0) {
                result.push([nums[i], nums[left], nums[right]]);
                while(left < right && nums[left] == nums[left + 1]) left++;
                while(left < right && nums[right] == nums[right + 1]) right--;
                left++;
                right++
            } else if(sum > 0) {
                right--;
            } else {
                left++
            }
        }
        
    }
    return result;
}
            </article>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="nofollow noopener noopener">CC BY-SA 3.0协议</a> 。转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-6">
                    
                    
                      <a href="/2021/03/18/react/QA/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">react/QA</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </div>
                  <div class="post-next col-6">
                    
                    
                      <a href="/2021/03/18/react/index/">
                        <span class="hidden-mobile">react/index</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

            
          </div>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    

    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/main.js" ></script>


  <script  src="/js/lazyload.js" ></script>



  
  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '.post-content',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>





  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>






<!-- Plugins -->



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "react/fiber&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>


















</body>
</html>
